<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wdd.studentmanager.mapper.ScoreMapper">

    <resultMap type="com.wdd.studentmanager.domain.Score" id="ScoreInfo">
        <result column="id" property="id"/>
        <result column="course_id" property="courseId"/>
        <result column="student_id" property="studentId"/>
        <result column="score" property="score"/>
        <result column="remark" property="remark"/>
        <result column="courseName" property="courseName"/>
        <result column="studentName" property="studentName"/>
    </resultMap>

    <select id="queryList" resultMap="ScoreInfo">
        SELECT * FROM s_score
        <where>
            <if test="courseid != null">AND course_id = #{courseid}</if>
            <if test="studentid != null">AND student_id = #{studentid}</if>
        </where>
        LIMIT #{pagesize} OFFSET #{startIndex}
    </select>

    <select id="queryCount" resultType="int">
        SELECT COUNT(*) FROM s_score
        <where>
            <if test="courseid != null">AND course_id = #{courseid}</if>
            <if test="studentid != null">AND student_id = #{studentid}</if>
        </where>
    </select>

    <insert id="addScore" parameterType="Score">
        INSERT INTO s_score(course_id, student_id, score, remark)
        VALUES (#{courseId}, #{studentId}, #{score}, #{remark})
    </insert>

    <delete id="deleteScore" parameterType="int">
        DELETE FROM s_score WHERE id = #{id}
    </delete>

    <select id="isScore" parameterType="Score" resultType="Score">
        SELECT * FROM s_score WHERE course_id = #{courseId} AND student_id = #{studentId}
    </select>

    <update id="editScore" parameterType="Score">
        UPDATE s_score SET course_id = #{courseId}, student_id = #{studentId},
                           score = #{score}, remark = #{remark}
        WHERE id = #{id}
    </update>

    <select id="getAll" parameterType="Score" resultMap="ScoreInfo">
        SELECT s_score.*, s_course.name AS courseName, s_student.username AS studentName
        FROM s_score
        INNER JOIN s_course ON s_score.course_id = s_course.id
        INNER JOIN s_student ON s_score.student_id = s_student.id
        <where>
            <if test="courseId != null and courseId != ''">AND s_score.course_id = #{courseId}</if>
            <if test="studentId != null and studentId != ''">AND s_score.student_id = #{studentId}</if>
        </where>
    </select>

    <select id="getAvgStats" parameterType="int" resultType="ScoreStats">
        SELECT MAX(s_score.score) AS max_score,
               AVG(s_score.score) AS avg_score,
               MIN(s_score.score) AS min_score,
               s_course.name AS courseName
        FROM s_score
                 INNER JOIN s_course ON s_score.course_id = s_course.id
        WHERE s_score.course_id = #{courseid}
    </select>

</mapper>